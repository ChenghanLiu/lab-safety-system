{"remainingRequest":"/Users/liuchenghan/Desktop/lab-safety-system/front/admin/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/liuchenghan/Desktop/lab-safety-system/front/admin/src/views/modules/reservation/list.vue?vue&type=script&lang=js","dependencies":[{"path":"/Users/liuchenghan/Desktop/lab-safety-system/front/admin/src/views/modules/reservation/list.vue","mtime":1771346017462},{"path":"/Users/liuchenghan/Desktop/lab-safety-system/front/admin/node_modules/cache-loader/dist/cjs.js","mtime":1771254462036},{"path":"/Users/liuchenghan/Desktop/lab-safety-system/front/admin/node_modules/babel-loader/lib/index.js","mtime":1771254462371},{"path":"/Users/liuchenghan/Desktop/lab-safety-system/front/admin/node_modules/cache-loader/dist/cjs.js","mtime":1771254462036},{"path":"/Users/liuchenghan/Desktop/lab-safety-system/front/admin/node_modules/vue-loader/lib/index.js","mtime":1771254462450}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:CmltcG9ydCBodHRwIGZyb20gIkAvdXRpbHMvaHR0cCI7CmltcG9ydCB7CiAgY3JlYXRlUmVzZXJ2YXRpb24sCiAgYXBwcm92ZVJlc2VydmF0aW9uLAogIHJlamVjdFJlc2VydmF0aW9uLAogIGNhbmNlbFJlc2VydmF0aW9uCn0gZnJvbSAiQC9hcGkvcmVzZXJ2YXRpb24iOwoKZXhwb3J0IGRlZmF1bHQgewogIGRhdGEoKSB7CiAgICByZXR1cm4gewogICAgICBsb2FkaW5nOiBmYWxzZSwKICAgICAgbGlzdDogW10sCiAgICAgIHRvdGFsOiAwLAogICAgICBwYWdlOiAxLAogICAgICBzaXplOiAxMCwKICAgICAgZGlhbG9nVmlzaWJsZTogZmFsc2UsCiAgICAgIGZvcm06IHsKICAgICAgICBsYWJJZDogIiIsCiAgICAgICAgZXF1aXBtZW50SWQ6ICIiLAogICAgICAgIHN0YXJ0VGltZTogIiIsCiAgICAgICAgZW5kVGltZTogIiIsCiAgICAgICAgcHVycG9zZTogIiIsCiAgICAgICAgcmVtYXJrOiAiIgogICAgICB9CiAgICB9OwogIH0sCgogIGNvbXB1dGVkOiB7CiAgICByb2xlKCkgewogICAgICByZXR1cm4gbG9jYWxTdG9yYWdlLmdldEl0ZW0oIlJvbGUiKSB8fCAiIjsKICAgIH0sCiAgICBpc1N0dWRlbnQoKSB7CiAgICAgIHJldHVybiB0aGlzLnJvbGUgPT09ICJTVFVERU5UIjsKICAgIH0sCiAgICBpc1RlYWNoZXIoKSB7CiAgICAgIHJldHVybiB0aGlzLnJvbGUgPT09ICJURUFDSEVSIjsKICAgIH0sCiAgICBpc0FkbWluKCkgewogICAgICByZXR1cm4gdGhpcy5yb2xlID09PSAiQURNSU4iOwogICAgfQogIH0sCgogIG1vdW50ZWQoKSB7CiAgICB0aGlzLmxvYWQoKTsKICB9LAoKICBtZXRob2RzOiB7CiAgICBhc3luYyBsb2FkKCkgewogICAgICB0aGlzLmxvYWRpbmcgPSB0cnVlOwoKICAgICAgLy8g4pyFIOaMieinkuiJsumAieWvueaOpeWPowogICAgICBjb25zdCBwYXJhbXMgPSB7IHBhZ2U6IHRoaXMucGFnZSAtIDEsIHNpemU6IHRoaXMuc2l6ZSB9OwogICAgICBsZXQgdXJsID0gIi9hcGkvcmVzZXJ2YXRpb25zIjsKCiAgICAgIGlmICh0aGlzLmlzU3R1ZGVudCkgdXJsID0gIi9hcGkvcmVzZXJ2YXRpb25zL215IjsKICAgICAgZWxzZSBpZiAodGhpcy5pc1RlYWNoZXIpIHVybCA9ICIvYXBpL3Jlc2VydmF0aW9ucy9wZW5kaW5nIjsKICAgICAgZWxzZSBpZiAodGhpcy5pc0FkbWluKSB1cmwgPSAiL2FwaS9yZXNlcnZhdGlvbnMiOwoKICAgICAgdHJ5IHsKICAgICAgICAvLyDinIUg5omT5Y2w5Ye65p2l5L2g5bCx55+l6YGT5Yiw5bqV5omT5Yiw5ZOq5Liq5o6l5Y+j5LqGCiAgICAgICAgY29uc29sZS5sb2coIltyZXNlcnZhdGlvbl0gR0VUIiwgdXJsLCBwYXJhbXMsICJyb2xlPSIsIHRoaXMucm9sZSk7CgogICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IGh0dHAoeyB1cmwsIG1ldGhvZDogIkdFVCIsIHBhcmFtcyB9KTsKCiAgICAgICAgY29uc3QgZGF0YSA9IHJlcyAmJiByZXMuZGF0YSA/IHJlcy5kYXRhIDoge307CiAgICAgICAgdGhpcy5saXN0ID0gZGF0YS5jb250ZW50IHx8IFtdOwogICAgICAgIHRoaXMudG90YWwgPSBOdW1iZXIoZGF0YS50b3RhbEVsZW1lbnRzIHx8IDApOwoKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnN0IHN0YXR1cyA9IGU/LnJlc3BvbnNlPy5zdGF0dXM7CiAgICAgICAgY29uc3QgbXNnID0gZT8ucmVzcG9uc2U/LmRhdGE/Lm1lc3NhZ2UgfHwgZT8ubWVzc2FnZSB8fCAi6K+35rGC5aSx6LSlIjsKCiAgICAgICAgY29uc29sZS5lcnJvcigiW3Jlc2VydmF0aW9uXSBFUlJPUiIsIHN0YXR1cywgZT8ucmVzcG9uc2U/LmRhdGEgfHwgZSk7CgogICAgICAgIGlmIChzdGF0dXMgPT09IDQwMSkgdGhpcy4kbWVzc2FnZS5lcnJvcigi55m75b2V6L+H5pyf77yM6K+36YeN5paw55m75b2VIik7CiAgICAgICAgZWxzZSBpZiAoc3RhdHVzID09PSA0MDMpIHRoaXMuJG1lc3NhZ2UuZXJyb3IoIuaXoOadg+mZkOiuv+mXrumihOe6puWIl+ihqCIpOwogICAgICAgIGVsc2UgdGhpcy4kbWVzc2FnZS5lcnJvcigi6aKE57qm5YiX6KGo5Yqg6L295aSx6LSl77yaIiArIG1zZyk7CgogICAgICAgIC8vIOWksei0peS5n+imgeaKiuaVsOaNrua4heS4gOS4i++8jOmBv+WFjeaXp+aVsOaNruivr+WvvAogICAgICAgIHRoaXMubGlzdCA9IFtdOwogICAgICAgIHRoaXMudG90YWwgPSAwOwoKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAvLyDinIUg5peg6K665oiQ5Yqf5aSx6LSl6YO95YWz6ZetIGxvYWRpbmfvvIzpgb/lhY3igJzljaHkvY/igJ0KICAgICAgICB0aGlzLmxvYWRpbmcgPSBmYWxzZTsKICAgICAgfQogICAgfSwKCiAgICBjaGFuZ2VQYWdlKHApIHsKICAgICAgdGhpcy5wYWdlID0gcDsKICAgICAgdGhpcy5sb2FkKCk7CiAgICB9LAoKICAgIG9wZW5DcmVhdGVEaWFsb2coKSB7CiAgICAgIHRoaXMuZGlhbG9nVmlzaWJsZSA9IHRydWU7CiAgICB9LAoKICAgIGFzeW5jIHN1Ym1pdCgpIHsKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCBjcmVhdGVSZXNlcnZhdGlvbih0aGlzLmZvcm0pOwogICAgICAgIHRoaXMuJG1lc3NhZ2Uuc3VjY2Vzcygi6aKE57qm5bey5o+Q5LqkIik7CiAgICAgICAgdGhpcy5kaWFsb2dWaXNpYmxlID0gZmFsc2U7CiAgICAgICAgdGhpcy5sb2FkKCk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zdCBtc2cgPSBlPy5yZXNwb25zZT8uZGF0YT8ubWVzc2FnZSB8fCBlPy5tZXNzYWdlIHx8ICLmj5DkuqTlpLHotKUiOwogICAgICAgIHRoaXMuJG1lc3NhZ2UuZXJyb3IoIuaPkOS6pOWksei0pe+8miIgKyBtc2cpOwogICAgICB9CiAgICB9LAoKICAgIGFzeW5jIGFwcHJvdmUoaWQpIHsKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCBhcHByb3ZlUmVzZXJ2YXRpb24oaWQsIHsgZGVjaXNpb25Ob3RlOiAiIiB9KTsKICAgICAgICB0aGlzLiRtZXNzYWdlLnN1Y2Nlc3MoIuW3sumAmui/hyIpOwogICAgICAgIHRoaXMubG9hZCgpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc3Qgc3RhdHVzID0gZT8ucmVzcG9uc2U/LnN0YXR1czsKICAgICAgICBjb25zdCBtc2cgPSBlPy5yZXNwb25zZT8uZGF0YT8ubWVzc2FnZSB8fCBlPy5tZXNzYWdlIHx8ICLlrqHmibnlpLHotKUiOwogICAgICAgIGNvbnNvbGUuZXJyb3IoIlthcHByb3ZlXSBFUlJPUiIsIHN0YXR1cywgZT8ucmVzcG9uc2U/LmRhdGEgfHwgZSk7CiAgICAgICAgdGhpcy4kbWVzc2FnZS5lcnJvcihtc2cpOwogICAgICB9CiAgICB9LAoKICAgIGFzeW5jIHJlamVjdChpZCkgewogICAgICB0cnkgewogICAgICAgIGF3YWl0IHJlamVjdFJlc2VydmF0aW9uKGlkLCB7IGRlY2lzaW9uTm90ZTogIiIgfSk7CiAgICAgICAgdGhpcy4kbWVzc2FnZS5zdWNjZXNzKCLlt7Lmi5Lnu50iKTsKICAgICAgICB0aGlzLmxvYWQoKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnN0IHN0YXR1cyA9IGU/LnJlc3BvbnNlPy5zdGF0dXM7CiAgICAgICAgY29uc3QgbXNnID0gZT8ucmVzcG9uc2U/LmRhdGE/Lm1lc3NhZ2UgfHwgZT8ubWVzc2FnZSB8fCAi5ouS57ud5aSx6LSlIjsKICAgICAgICBjb25zb2xlLmVycm9yKCJbcmVqZWN0XSBFUlJPUiIsIHN0YXR1cywgZT8ucmVzcG9uc2U/LmRhdGEgfHwgZSk7CiAgICAgICAgdGhpcy4kbWVzc2FnZS5lcnJvcihtc2cpOwogICAgICB9CiAgICB9LAoKICAgIGFzeW5jIGNhbmNlbChpZCkgewogICAgICB0cnkgewogICAgICAgIGF3YWl0IGNhbmNlbFJlc2VydmF0aW9uKGlkKTsKICAgICAgICB0aGlzLiRtZXNzYWdlLnN1Y2Nlc3MoIuW3suWPlua2iCIpOwogICAgICAgIHRoaXMubG9hZCgpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc3Qgc3RhdHVzID0gZT8ucmVzcG9uc2U/LnN0YXR1czsKICAgICAgICBjb25zdCBtc2cgPSBlPy5yZXNwb25zZT8uZGF0YT8ubWVzc2FnZSB8fCBlPy5tZXNzYWdlIHx8ICLlj5bmtojlpLHotKUiOwogICAgICAgIGNvbnNvbGUuZXJyb3IoIltjYW5jZWxdIEVSUk9SIiwgc3RhdHVzLCBlPy5yZXNwb25zZT8uZGF0YSB8fCBlKTsKICAgICAgICB0aGlzLiRtZXNzYWdlLmVycm9yKG1zZyk7CiAgICAgIH0KICAgIH0KCiAgfQp9Owo="},{"version":3,"sources":["list.vue"],"names":[],"mappings":";AAyFA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA","file":"list.vue","sourceRoot":"src/views/modules/reservation","sourcesContent":["<template>\n  <div>\n    <el-card>\n\n      <div style=\"margin-bottom: 16px;\">\n        <el-button v-if=\"isStudent\" type=\"primary\" @click=\"openCreateDialog\">\n          新建预约\n        </el-button>\n      </div>\n\n      <el-table :data=\"list\" border v-loading=\"loading\">\n        <el-table-column prop=\"id\" label=\"ID\" width=\"70\" />\n        <el-table-column prop=\"labName\" label=\"实验室\" />\n        <el-table-column prop=\"equipmentName\" label=\"设备\" />\n        <el-table-column prop=\"studentUsername\" label=\"学生\" />\n        <el-table-column prop=\"status\" label=\"状态\" />\n        <el-table-column prop=\"startTime\" label=\"开始时间\" />\n        <el-table-column prop=\"endTime\" label=\"结束时间\" />\n        <el-table-column prop=\"purpose\" label=\"用途\" />\n\n        <el-table-column label=\"操作\" width=\"220\">\n          <template slot-scope=\"scope\">\n            <template v-if=\"isTeacher && scope.row.status === 'PENDING'\">\n              <el-button size=\"mini\" type=\"success\" @click=\"approve(scope.row.id)\">通过</el-button>\n              <el-button size=\"mini\" type=\"danger\" @click=\"reject(scope.row.id)\">拒绝</el-button>\n            </template>\n\n            <template v-if=\"isStudent && scope.row.status === 'PENDING'\">\n              <el-button size=\"mini\" type=\"danger\" @click=\"cancel(scope.row.id)\">取消</el-button>\n            </template>\n          </template>\n        </el-table-column>\n      </el-table>\n\n      <el-pagination\n          style=\"margin-top:16px;\"\n          background\n          layout=\"total, prev, pager, next\"\n          :total=\"total\"\n          :page-size=\"size\"\n          @current-change=\"changePage\"\n      />\n    </el-card>\n\n    <el-dialog title=\"新建预约\" :visible.sync=\"dialogVisible\">\n      <el-form :model=\"form\">\n        <el-form-item label=\"实验室ID\">\n          <el-input v-model=\"form.labId\" />\n        </el-form-item>\n\n        <el-form-item label=\"设备ID\">\n          <el-input v-model=\"form.equipmentId\" />\n        </el-form-item>\n\n        <el-form-item label=\"开始时间\">\n          <el-date-picker\n              v-model=\"form.startTime\"\n              type=\"datetime\"\n              value-format=\"yyyy-MM-ddTHH:mm:ss\"\n          />\n        </el-form-item>\n\n        <el-form-item label=\"结束时间\">\n          <el-date-picker\n              v-model=\"form.endTime\"\n              type=\"datetime\"\n              value-format=\"yyyy-MM-ddTHH:mm:ss\"\n          />\n        </el-form-item>\n\n        <el-form-item label=\"用途\">\n          <el-input v-model=\"form.purpose\" />\n        </el-form-item>\n\n        <el-form-item label=\"备注\">\n          <el-input v-model=\"form.remark\" />\n        </el-form-item>\n      </el-form>\n\n      <span slot=\"footer\">\n        <el-button @click=\"dialogVisible=false\">取消</el-button>\n        <el-button type=\"primary\" @click=\"submit\">提交</el-button>\n      </span>\n    </el-dialog>\n\n  </div>\n</template>\n\n<script>\nimport http from \"@/utils/http\";\nimport {\n  createReservation,\n  approveReservation,\n  rejectReservation,\n  cancelReservation\n} from \"@/api/reservation\";\n\nexport default {\n  data() {\n    return {\n      loading: false,\n      list: [],\n      total: 0,\n      page: 1,\n      size: 10,\n      dialogVisible: false,\n      form: {\n        labId: \"\",\n        equipmentId: \"\",\n        startTime: \"\",\n        endTime: \"\",\n        purpose: \"\",\n        remark: \"\"\n      }\n    };\n  },\n\n  computed: {\n    role() {\n      return localStorage.getItem(\"Role\") || \"\";\n    },\n    isStudent() {\n      return this.role === \"STUDENT\";\n    },\n    isTeacher() {\n      return this.role === \"TEACHER\";\n    },\n    isAdmin() {\n      return this.role === \"ADMIN\";\n    }\n  },\n\n  mounted() {\n    this.load();\n  },\n\n  methods: {\n    async load() {\n      this.loading = true;\n\n      // ✅ 按角色选对接口\n      const params = { page: this.page - 1, size: this.size };\n      let url = \"/api/reservations\";\n\n      if (this.isStudent) url = \"/api/reservations/my\";\n      else if (this.isTeacher) url = \"/api/reservations/pending\";\n      else if (this.isAdmin) url = \"/api/reservations\";\n\n      try {\n        // ✅ 打印出来你就知道到底打到哪个接口了\n        console.log(\"[reservation] GET\", url, params, \"role=\", this.role);\n\n        const res = await http({ url, method: \"GET\", params });\n\n        const data = res && res.data ? res.data : {};\n        this.list = data.content || [];\n        this.total = Number(data.totalElements || 0);\n\n      } catch (e) {\n        const status = e?.response?.status;\n        const msg = e?.response?.data?.message || e?.message || \"请求失败\";\n\n        console.error(\"[reservation] ERROR\", status, e?.response?.data || e);\n\n        if (status === 401) this.$message.error(\"登录过期，请重新登录\");\n        else if (status === 403) this.$message.error(\"无权限访问预约列表\");\n        else this.$message.error(\"预约列表加载失败：\" + msg);\n\n        // 失败也要把数据清一下，避免旧数据误导\n        this.list = [];\n        this.total = 0;\n\n      } finally {\n        // ✅ 无论成功失败都关闭 loading，避免“卡住”\n        this.loading = false;\n      }\n    },\n\n    changePage(p) {\n      this.page = p;\n      this.load();\n    },\n\n    openCreateDialog() {\n      this.dialogVisible = true;\n    },\n\n    async submit() {\n      try {\n        await createReservation(this.form);\n        this.$message.success(\"预约已提交\");\n        this.dialogVisible = false;\n        this.load();\n      } catch (e) {\n        const msg = e?.response?.data?.message || e?.message || \"提交失败\";\n        this.$message.error(\"提交失败：\" + msg);\n      }\n    },\n\n    async approve(id) {\n      try {\n        await approveReservation(id, { decisionNote: \"\" });\n        this.$message.success(\"已通过\");\n        this.load();\n      } catch (e) {\n        const status = e?.response?.status;\n        const msg = e?.response?.data?.message || e?.message || \"审批失败\";\n        console.error(\"[approve] ERROR\", status, e?.response?.data || e);\n        this.$message.error(msg);\n      }\n    },\n\n    async reject(id) {\n      try {\n        await rejectReservation(id, { decisionNote: \"\" });\n        this.$message.success(\"已拒绝\");\n        this.load();\n      } catch (e) {\n        const status = e?.response?.status;\n        const msg = e?.response?.data?.message || e?.message || \"拒绝失败\";\n        console.error(\"[reject] ERROR\", status, e?.response?.data || e);\n        this.$message.error(msg);\n      }\n    },\n\n    async cancel(id) {\n      try {\n        await cancelReservation(id);\n        this.$message.success(\"已取消\");\n        this.load();\n      } catch (e) {\n        const status = e?.response?.status;\n        const msg = e?.response?.data?.message || e?.message || \"取消失败\";\n        console.error(\"[cancel] ERROR\", status, e?.response?.data || e);\n        this.$message.error(msg);\n      }\n    }\n\n  }\n};\n</script>\n"]}]}